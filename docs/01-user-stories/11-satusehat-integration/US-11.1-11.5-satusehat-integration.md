# Satusehat Integration (FHIR R4)

> **Module**: 11 - Satusehat Integration
> **Stories**: US-11.1 to US-11.5
> **Priority**: P0 (Critical)
> **Standard**: FHIR R4 (HL7 Fast Healthcare Interoperability Resources)
> **Endpoint**: https://api-satusehat.kemkes.go.id

---

## US-11.1: Authentication & Organization Setup

### User Story
**As a** system administrator
**I want to** configure Satusehat credentials
**So that** the clinic can exchange data with Satusehat

### Acceptance Criteria

- [ ] **GIVEN** clinic has Satusehat credentials
      **WHEN** configuring integration
      **THEN** system stores client_id, client_secret securely

- [ ] **GIVEN** credentials are configured
      **WHEN** requesting access token
      **THEN** system obtains OAuth2 token and refreshes before expiry

### OAuth2 Flow

```
POST /oauth2/v1/accesstoken
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id={client_id}
&client_secret={client_secret}

Response:
{
  "access_token": "...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

### Data Model

```yaml
satusehat_config:
  id: uuid
  organization_id: uuid (FK)

  # Credentials
  client_id: string (encrypted)
  client_secret: string (encrypted)
  environment: enum (sandbox/production)

  # Organization IDs
  org_satusehat_id: string # Organization ID in Satusehat
  org_name: string

  # Token management
  current_access_token: string (encrypted)
  token_expires_at: datetime
  last_token_refresh: datetime

  # Status
  is_active: boolean (default: true)
  last_sync_at: datetime (nullable)
  last_error: text (nullable)

  created_at: datetime
  updated_at: datetime

satusehat_location:
  id: uuid
  polyclinic_id: uuid (FK)
  satusehat_location_id: string
  location_name: string
  location_type: string
  synced_at: datetime
  status: enum (active/inactive)

satusehat_practitioner:
  id: uuid
  practitioner_id: uuid (FK)
  ihs_number: string # Satusehat Practitioner ID
  nik: string
  practitioner_name: string
  verified_at: datetime
  verification_method: enum (nik_lookup/manual)
  status: enum (active/inactive)
```

---

## US-11.2: Resource Sync Workflow

### User Story
**As a** clinical system
**I want to** sync clinical data to Satusehat
**So that** patient data is integrated nationally

### Acceptance Criteria

- [ ] **GIVEN** clinical event occurs
      **WHEN** Satusehat sync is triggered
      **THEN** system sends FHIR resources in correct order

### Sync Order (Critical Dependencies)

```
┌─────────────────────────────────────────────────────────┐
│  PREREQUISITES (One-time setup)                         │
├─────────────────────────────────────────────────────────┤
│  1. Organization  → Get org_satusehat_id               │
│  2. Location      → Create for each polyclinic         │
│  3. Practitioner  → Lookup IHS ID by NIK               │
│  4. PractitionerRole → Link Practitioner to Location   │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  PER PATIENT (First visit)                              │
├─────────────────────────────────────────────────────────┤
│  5. Patient       → Search by NIK, get IHS Patient ID  │
│     - If not found, patient must be registered         │
│       in Satusehat via other channel (e.g., P-Care)    │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  PER ENCOUNTER (Each visit)                             │
├─────────────────────────────────────────────────────────┤
│  6. Encounter     → Create (status: arrived)           │
│  7. Observation   → Vital signs (link to Encounter)    │
│  8. Condition     → Diagnoses (link to Encounter)      │
│  9. Procedure     → Procedures (link to Encounter)     │
│ 10. MedicationRequest → Prescriptions                  │
│ 11. MedicationDispense → Pharmacy dispense             │
│ 12. ServiceRequest → Lab orders                        │
│ 13. DiagnosticReport → Lab results                     │
│ 14. Encounter     → Update (status: finished)          │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  COMPLETION                                             │
├─────────────────────────────────────────────────────────┤
│ 15. Composition   → Resume Medis bundle                 │
└─────────────────────────────────────────────────────────┘
```

### Data Model

```yaml
satusehat_sync_queue:
  id: uuid
  resource_type: enum (Patient/Encounter/Condition/Observation/Procedure/MedicationRequest/MedicationDispense/ServiceRequest/DiagnosticReport)
  resource_id: uuid # local ID
  operation: enum (create/update/search)

  # Payload
  fhir_resource: jsonb # FHIR resource to send

  # Dependencies
  depends_on: array[uuid] # other sync queue items that must complete first
  encounter_id: uuid (FK, nullable) # group by encounter

  # Status
  status: enum (pending/processing/completed/failed/skipped)
  priority: integer (default: 0)

  # Retry
  retry_count: integer (default: 0)
  max_retries: integer (default: 3)
  next_retry_at: datetime (nullable)

  # Results
  satusehat_id: string (nullable) # returned ID
  response_status: integer (nullable)
  response_body: jsonb (nullable)
  error_message: text (nullable)

  # Timestamps
  created_at: datetime
  started_at: datetime (nullable)
  completed_at: datetime (nullable)

satusehat_sync_log:
  id: uuid
  sync_queue_id: uuid (FK)
  attempt_number: integer

  # Request
  request_method: string # GET, POST, PUT
  request_url: string
  request_headers: jsonb
  request_body: jsonb

  # Response
  response_status: integer
  response_headers: jsonb
  response_body: jsonb
  response_time_ms: integer

  # Result
  success: boolean
  error_type: string (nullable)
  error_message: text (nullable)

  timestamp: datetime
```

---

## US-11.3: Patient IHS Lookup

### User Story
**As a** registration staff
**I want to** lookup patient's IHS ID from Satusehat
**So that** patient can be identified nationally

### Acceptance Criteria

- [ ] **GIVEN** patient NIK is entered
      **WHEN** searching Satusehat
      **THEN** system retrieves IHS Patient ID if registered

### API Endpoint

```
GET /fhir-r4/v1/Patient?identifier=https://fhir.kemkes.go.id/id/nik|{NIK}

Response:
{
  "resourceType": "Bundle",
  "entry": [
    {
      "resource": {
        "resourceType": "Patient",
        "id": "{IHS_ID}",
        "identifier": [
          {
            "system": "https://fhir.kemkes.go.id/id/nik",
            "value": "{NIK}"
          }
        ],
        "name": [{"text": "..."}],
        "gender": "...",
        "birthDate": "..."
      }
    }
  ]
}
```

### Data Model

```yaml
patient_ihs_lookup:
  id: uuid
  patient_id: uuid (FK)
  nik: string

  # Search result
  lookup_status: enum (found/not_found/error)
  ihs_patient_id: string (nullable)
  ihs_patient_data: jsonb (nullable) # full Patient resource

  # If not found
  registration_required: boolean (default: false)
  registration_instructions: text (nullable)

  # Metadata
  searched_at: datetime
  searched_by: uuid (FK)
```

---

## US-11.4: Encounter Bundle Sync

### User Story
**As a** clinical system
**I want to** sync complete encounter data
**So that** all clinical information is recorded in Satusehat

### Acceptance Criteria

- [ ] **GIVEN** encounter is completed
      **WHEN** syncing to Satusehat
      **THEN** all related resources are sent in correct sequence

### Example FHIR Resources

#### Encounter (Outpatient)

```json
{
  "resourceType": "Encounter",
  "identifier": [
    {
      "system": "http://sys-ids.kemkes.go.id/encounter/{org_id}",
      "value": "ENC-20251226-0001"
    }
  ],
  "status": "finished",
  "class": {
    "system": "http://terminology.hl7.org/CodeSystem/v3-ActCode",
    "code": "AMB",
    "display": "ambulatory"
  },
  "subject": {
    "reference": "Patient/{ihs_patient_id}",
    "display": "Patient Name"
  },
  "participant": [
    {
      "type": [
        {
          "coding": [
            {
              "system": "http://terminology.hl7.org/CodeSystem/v3-ParticipationType",
              "code": "ATND",
              "display": "attender"
            }
          ]
        }
      ],
      "individual": {
        "reference": "Practitioner/{ihs_practitioner_id}",
        "display": "Dr. Name"
      }
    }
  ],
  "period": {
    "start": "2025-12-26T09:00:00+07:00",
    "end": "2025-12-26T09:30:00+07:00"
  },
  "location": [
    {
      "location": {
        "reference": "Location/{satusehat_location_id}",
        "display": "Poli Umum"
      }
    }
  ],
  "serviceProvider": {
    "reference": "Organization/{org_satusehat_id}"
  }
}
```

#### Condition (Diagnosis)

```json
{
  "resourceType": "Condition",
  "clinicalStatus": {
    "coding": [
      {
        "system": "http://terminology.hl7.org/CodeSystem/condition-clinical",
        "code": "active",
        "display": "Active"
      }
    ]
  },
  "category": [
    {
      "coding": [
        {
          "system": "http://terminology.hl7.org/CodeSystem/condition-category",
          "code": "encounter-diagnosis",
          "display": "Encounter Diagnosis"
        }
      ]
    }
  ],
  "code": {
    "coding": [
      {
        "system": "http://hl7.org/fhir/sid/icd-10",
        "code": "J06.9",
        "display": "Acute upper respiratory infection, unspecified"
      }
    ]
  },
  "subject": {
    "reference": "Patient/{ihs_patient_id}"
  },
  "encounter": {
    "reference": "Encounter/{satusehat_encounter_id}"
  },
  "recordedDate": "2025-12-26"
}
```

#### Observation (Vital Signs)

```json
{
  "resourceType": "Observation",
  "status": "final",
  "category": [
    {
      "coding": [
        {
          "system": "http://terminology.hl7.org/CodeSystem/observation-category",
          "code": "vital-signs",
          "display": "Vital Signs"
        }
      ]
    }
  ],
  "code": {
    "coding": [
      {
        "system": "http://loinc.org",
        "code": "8480-6",
        "display": "Systolic blood pressure"
      }
    ]
  },
  "subject": {
    "reference": "Patient/{ihs_patient_id}"
  },
  "encounter": {
    "reference": "Encounter/{satusehat_encounter_id}"
  },
  "effectiveDateTime": "2025-12-26T09:00:00+07:00",
  "valueQuantity": {
    "value": 120,
    "unit": "mmHg",
    "system": "http://unitsofmeasure.org",
    "code": "mm[Hg]"
  }
}
```

---

## US-11.5: Error Handling & Retry

### User Story
**As a** system administrator
**I want to** handle sync failures gracefully
**So that** data integrity is maintained

### Acceptance Criteria

- [ ] **GIVEN** sync fails
      **WHEN** error is transient
      **THEN** system retries with exponential backoff

- [ ] **GIVEN** sync fails permanently
      **WHEN** error is not recoverable
      **THEN** system logs and alerts for manual intervention

### Error Categories

| Category | Examples | Action |
|----------|----------|--------|
| **Transient** | 429 (rate limit), 503 (unavailable) | Retry with backoff |
| **Client Error** | 400 (bad request), 422 (validation) | Log, fix data, retry |
| **Auth Error** | 401 (unauthorized) | Refresh token, retry |
| **Not Found** | 404 (resource not found) | Check dependencies |
| **Server Error** | 500, 502, 504 | Retry, escalate if persistent |

### Data Model

```yaml
satusehat_error_log:
  id: uuid
  sync_queue_id: uuid (FK, nullable)
  resource_type: string
  resource_id: string
  operation: string

  # Error details
  error_category: enum (transient/client/auth/not_found/server/unknown)
  http_status: integer (nullable)
  error_code: string (nullable)
  error_message: text
  error_details: jsonb (nullable)

  # Request info
  request_url: string
  request_body: jsonb (nullable)
  response_body: jsonb (nullable)

  # Resolution
  resolution_status: enum (pending/auto_resolved/manual_resolved/ignored)
  resolution_notes: text (nullable)
  resolved_by: uuid (FK, nullable)
  resolved_at: datetime (nullable)

  timestamp: datetime

satusehat_health_check:
  id: uuid
  check_datetime: datetime
  endpoint_checked: string
  response_time_ms: integer
  status: enum (healthy/degraded/unhealthy)
  error_message: text (nullable)
```

### Retry Configuration

```yaml
retry_config:
  max_retries: 3
  initial_delay_ms: 1000
  max_delay_ms: 60000
  backoff_multiplier: 2

  # Rate limiting
  requests_per_minute: 60
  burst_size: 10

  # Circuit breaker
  failure_threshold: 5
  recovery_timeout_ms: 30000
```

---

## Consent Management

### Patient Consent for Data Sharing

```yaml
satusehat_consent:
  id: uuid
  patient_id: uuid (FK)

  # Consent
  consent_given: boolean
  consent_scope: enum (all/encounter_only/none)
  consent_datetime: datetime
  consent_method: enum (written/verbal/electronic)

  # Witness/Verification
  witnessed_by: uuid (FK, nullable)
  consent_document_url: string (nullable)

  # Validity
  valid_from: datetime
  valid_until: datetime (nullable)

  # Revocation
  revoked: boolean (default: false)
  revoked_at: datetime (nullable)
  revoked_reason: text (nullable)
```

---

## Dependencies
- All clinical modules (data sources)
- Patient Management (patient data)
- Practitioners (practitioner IHS IDs)

## Blocks
- BPJS Integration (requires Satusehat data)

