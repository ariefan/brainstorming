# Billing & Payment

> **Module**: 10 - Billing & Payment
> **Stories**: US-10.1 to US-10.6
> **Priority**: P0 (Critical)
> **Integration**: BPJS INA-CBG, Payment Gateway

---

## US-10.1: Service Tariff Master

### User Story
**As a** billing administrator
**I want to** manage service tariffs
**So that** charges are consistent and accurate

### Acceptance Criteria

- [ ] **GIVEN** service is configured
      **WHEN** setting tariff
      **THEN** system supports multiple tariff types (general, BPJS)

### Data Model

```yaml
service_tariff:
  id: uuid
  service_code: string (unique)
  service_name: string
  service_name_id: string # Indonesian

  # Category
  category: enum (consultation/procedure/lab/radiology/pharmacy/room/nursing/other)
  subcategory: string (nullable)

  # Procedure coding
  icd9cm_code: string (nullable)

  # Pricing
  base_price: decimal
  is_negotiable: boolean (default: false)

  # BPJS
  is_bpjs_claimable: boolean (default: true)
  bpjs_tariff_code: string (nullable)
  bpjs_price: decimal (nullable)

  # Components (for composite services)
  is_composite: boolean (default: false)
  components: jsonb # array of {service_code, quantity}

  # By polyclinic
  polyclinic_specific: boolean (default: false)
  applicable_polyclinics: array[uuid]

  # Validity
  effective_from: date
  effective_until: date (nullable)

  is_active: boolean (default: true)

tariff_class:
  id: uuid
  class_name: string # e.g., "General", "BPJS Class 1", "VIP"
  class_code: string
  multiplier: decimal (default: 1.0) # price adjustment factor
  is_default: boolean (default: false)
  is_active: boolean (default: true)
```

---

## US-10.2: Auto Charge Capture

### User Story
**As a** billing staff
**I want to** automatically capture charges from clinical activities
**So that** no billable services are missed

### Acceptance Criteria

- [ ] **GIVEN** clinical service is provided
      **WHEN** documented in encounter
      **THEN** charge is automatically created

### Charge Sources
- Consultation (encounter)
- Procedures (medical services)
- Medications (pharmacy dispense)
- Laboratory (lab results)
- Room charges (inpatient daily)
- Nursing services (inpatient)

### Data Model

```yaml
charge:
  id: uuid
  charge_number: string (auto-generated)

  # Source
  patient_id: uuid (FK)
  encounter_id: uuid (FK)
  admission_id: uuid (FK, nullable)

  # Service
  service_id: uuid (FK)
  service_code: string
  service_name: string

  # Reference
  source_type: enum (encounter/procedure/medication/lab/room/nursing/other)
  source_id: uuid # reference to source record

  # Quantity & Pricing
  quantity: decimal (default: 1)
  unit_price: decimal
  discount_percent: decimal (default: 0)
  discount_amount: decimal (default: 0)
  subtotal: decimal # quantity * unit_price
  total: decimal # subtotal - discount

  # Tariff class
  tariff_class_id: uuid (FK)

  # BPJS
  is_bpjs: boolean (default: false)
  bpjs_tariff_code: string (nullable)
  bpjs_claim_amount: decimal (nullable)

  # Status
  status: enum (pending/invoiced/paid/cancelled/adjusted)

  # Dates
  service_date: datetime
  charge_date: datetime
  invoiced_date: datetime (nullable)
  paid_date: datetime (nullable)

  # Staff
  charged_by: uuid (FK)
  charged_at: datetime

  notes: text

charge_adjustment:
  id: uuid
  charge_id: uuid (FK)
  adjustment_type: enum (discount/correction/write_off/reversal)
  original_amount: decimal
  adjustment_amount: decimal
  new_amount: decimal
  reason: text
  approved_by: uuid (FK)
  adjusted_at: datetime
```

---

## US-10.3: Invoice Generation

### User Story
**As a** cashier
**I want to** generate invoices for patients
**So that** payments can be collected

### Acceptance Criteria

- [ ] **GIVEN** charges are captured
      **WHEN** patient is ready to pay
      **THEN** system generates itemized invoice

### Data Model

```yaml
invoice:
  id: uuid
  invoice_number: string (format: INV-YYYYMMDD-XXXX)

  # Patient & Visit
  patient_id: uuid (FK)
  encounter_id: uuid (FK, nullable)
  admission_id: uuid (FK, nullable)

  # Type
  invoice_type: enum (outpatient/inpatient/pharmacy_only/lab_only)

  # Payer
  payer_type: enum (self_pay/bpjs/insurance/corporate)
  payer_id: uuid (FK, nullable) # insurance/corporate ID
  payer_name: string (nullable)

  # BPJS
  is_bpjs: boolean (default: false)
  bpjs_sep_number: string (nullable)
  bpjs_class: enum (1/2/3, nullable)

  # Amounts
  subtotal: decimal # sum of charges
  discount_total: decimal (default: 0)
  tax_total: decimal (default: 0)
  grand_total: decimal
  bpjs_covered: decimal (default: 0)
  insurance_covered: decimal (default: 0)
  patient_responsibility: decimal

  # Deposit
  deposit_applied: decimal (default: 0)
  deposit_balance: decimal (default: 0)

  # Status
  status: enum (draft/pending/partial/paid/cancelled/void)

  # Dates
  invoice_date: datetime
  due_date: date
  paid_date: datetime (nullable)

  # Staff
  created_by: uuid (FK)
  finalized_by: uuid (FK, nullable)

  notes: text

invoice_item:
  id: uuid
  invoice_id: uuid (FK)
  charge_id: uuid (FK)
  line_number: integer

  # Item details
  service_code: string
  service_name: string
  quantity: decimal
  unit_price: decimal
  discount: decimal (default: 0)
  total: decimal

  # BPJS
  bpjs_claim_amount: decimal (nullable)
  patient_portion: decimal
```

---

## US-10.4: Payment Processing

### User Story
**As a** cashier
**I want to** process multiple payment methods
**So that** patients can pay conveniently

### Acceptance Criteria

- [ ] **GIVEN** invoice is generated
      **WHEN** patient pays
      **THEN** system accepts cash, debit, credit, or QRIS

- [ ] **GIVEN** payment is split
      **WHEN** multiple methods used
      **THEN** system tracks each payment

### Data Model

```yaml
payment:
  id: uuid
  payment_number: string (format: PAY-YYYYMMDD-XXXX)
  invoice_id: uuid (FK)
  patient_id: uuid (FK)

  # Amount
  amount_due: decimal
  amount_paid: decimal
  change_amount: decimal (for cash)

  # Split payment tracking
  payment_complete: boolean
  remaining_balance: decimal

  # Status
  status: enum (completed/partial/cancelled/refunded)

  # Timestamps
  payment_date: datetime
  created_by: uuid (FK)

  notes: text

payment_item:
  id: uuid
  payment_id: uuid (FK)

  # Payment method
  payment_method: enum (cash/debit/credit/qris/transfer/deposit/insurance/bpjs)
  amount: decimal

  # Card details (if applicable)
  card_type: string (nullable) # Visa, Mastercard, etc.
  card_last_4: string (nullable)
  approval_code: string (nullable)
  terminal_id: string (nullable)

  # Bank transfer (if applicable)
  bank_name: string (nullable)
  account_number: string (nullable)
  transfer_reference: string (nullable)

  # QRIS (if applicable)
  qris_reference: string (nullable)
  qris_merchant_id: string (nullable)

  # EDC receipt
  edc_receipt_number: string (nullable)

  # Timestamp
  processed_at: datetime
  processed_by: uuid (FK)

receipt:
  id: uuid
  receipt_number: string (format: RCP-YYYYMMDD-XXXX)
  payment_id: uuid (FK)
  invoice_id: uuid (FK)
  patient_id: uuid (FK)

  # Content
  receipt_type: enum (payment/deposit/refund)
  amount: decimal

  # Print info
  printed_at: datetime (nullable)
  printed_by: uuid (FK, nullable)
  reprint_count: integer (default: 0)

  # Digital receipt
  sent_email: boolean (default: false)
  sent_whatsapp: boolean (default: false)
```

---

## US-10.5: Deposit & Refund Handling

### User Story
**As a** cashier
**I want to** manage patient deposits
**So that** prepayments are tracked accurately

### Acceptance Criteria

- [ ] **GIVEN** patient makes deposit
      **WHEN** for admission
      **THEN** system records and tracks deposit

- [ ] **GIVEN** patient has remaining deposit
      **WHEN** after billing
      **THEN** system processes refund

### Data Model

```yaml
deposit:
  id: uuid
  deposit_number: string (format: DEP-YYYYMMDD-XXXX)
  patient_id: uuid (FK)
  admission_id: uuid (FK, nullable)

  # Amount
  deposit_amount: decimal
  used_amount: decimal (default: 0)
  balance: decimal (calculated)

  # Payment method
  payment_method: enum (cash/debit/credit/transfer)
  payment_reference: string (nullable)

  # Status
  status: enum (active/applied/refunded/expired)

  # Timestamps
  deposit_date: datetime
  received_by: uuid (FK)

  # Refund (if applicable)
  refund_id: uuid (FK, nullable)

  notes: text

deposit_usage:
  id: uuid
  deposit_id: uuid (FK)
  invoice_id: uuid (FK)
  payment_id: uuid (FK)
  amount_used: decimal
  usage_date: datetime
  used_by: uuid (FK)

refund:
  id: uuid
  refund_number: string (format: REF-YYYYMMDD-XXXX)
  patient_id: uuid (FK)

  # Source
  source_type: enum (deposit/overpayment/cancellation)
  source_id: uuid # deposit or payment ID

  # Amount
  refund_amount: decimal

  # Method
  refund_method: enum (cash/transfer)
  bank_name: string (nullable)
  account_number: string (nullable)
  account_name: string (nullable)
  transfer_reference: string (nullable)

  # Status
  status: enum (pending/approved/processed/completed)

  # Workflow
  requested_at: datetime
  requested_by: uuid (FK)
  approved_at: datetime (nullable)
  approved_by: uuid (FK, nullable)
  processed_at: datetime (nullable)
  processed_by: uuid (FK, nullable)

  reason: text
  notes: text
```

---

## US-10.6: Daily Cash Closing

### User Story
**As a** cashier supervisor
**I want to** reconcile daily cash transactions
**So that** financial records are accurate

### Acceptance Criteria

- [ ] **GIVEN** end of shift/day
      **WHEN** performing cash closing
      **THEN** system compares expected vs actual cash

### Data Model

```yaml
cash_register:
  id: uuid
  register_name: string
  location: string

  # Opening
  opening_balance: decimal (default: 0)
  opening_datetime: datetime (nullable)
  opened_by: uuid (FK, nullable)

  # Current
  current_balance: decimal (calculated)
  status: enum (open/closed)

  # Assignment
  assigned_to: uuid (FK, nullable)

cash_closing:
  id: uuid
  closing_number: string (format: CLO-YYYYMMDD-XXXX)
  register_id: uuid (FK)
  closing_date: date
  shift: enum (morning/afternoon/evening/night)

  # Opening
  opening_balance: decimal
  opening_time: datetime

  # Transactions
  total_cash_in: decimal # cash payments received
  total_cash_out: decimal # change given, refunds
  total_deposit_in: decimal
  total_deposit_refund: decimal

  # Non-cash
  total_debit: decimal
  total_credit: decimal
  total_qris: decimal
  total_transfer: decimal

  # Expected vs Actual
  expected_cash: decimal (calculated)
  actual_cash: decimal
  variance: decimal (calculated)
  variance_status: enum (balanced/short/over)
  variance_reason: text (nullable)

  # Closing
  closing_time: datetime
  closed_by: uuid (FK)
  verified_by: uuid (FK, nullable)

  # Status
  status: enum (pending/closed/verified)

  notes: text

cash_closing_detail:
  id: uuid
  cash_closing_id: uuid (FK)

  # Denomination count (for cash)
  denomination: integer # 100000, 50000, 20000, etc.
  quantity: integer
  total: decimal

# Or for payment summary
cash_closing_payment_summary:
  id: uuid
  cash_closing_id: uuid (FK)
  payment_method: enum
  transaction_count: integer
  total_amount: decimal
```

---

## Financial Reports

### Daily Revenue Summary

```yaml
daily_revenue_report:
  report_date: date

  # By category
  revenue_by_category:
    - category: string
      transaction_count: integer
      gross_amount: decimal
      discount: decimal
      net_amount: decimal

  # By payment method
  revenue_by_payment:
    - method: string
      transaction_count: integer
      amount: decimal

  # By payer
  revenue_by_payer:
    - payer_type: string
      transaction_count: integer
      amount: decimal

  # Outstanding
  outstanding_receivables: decimal
  outstanding_count: integer

  # Totals
  total_gross: decimal
  total_discount: decimal
  total_net: decimal
  total_bpjs_pending: decimal
```

---

## Dependencies
- All clinical modules (charge sources)
- Patient Management (patient data)
- BPJS Integration (claim amounts)

## Blocks
- Financial Reporting
- BPJS Claims

