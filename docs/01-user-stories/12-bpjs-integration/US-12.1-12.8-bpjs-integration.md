# BPJS Kesehatan Integration

> **Module**: 12 - BPJS Integration
> **Stories**: US-12.1 to US-12.8
> **Priority**: P0 (Critical)
> **APIs**: VClaim, PCare, Antrean, Apotek, E-Klaim, Aplicares, i-Care
> **Documentation**: [BPJS TrustMark Portal](https://dvlp.bpjs-kesehatan.go.id:8888/trust-mark/portal.html)

---

## Overview

BPJS Kesehatan (Badan Penyelenggara Jaminan Sosial Kesehatan) is Indonesia's national health insurance program. Integration requires connecting to multiple APIs based on facility type:

| API | Purpose | Facility Level | Base URL (Production) |
|-----|---------|----------------|----------------------|
| **VClaim** | SEP, claims, referrals | FKRTL (Hospital/Clinic) | `https://apijkn.bpjs-kesehatan.go.id/vclaim-rest` |
| **PCare** | Primary care visits | FKTP (Puskesmas) | `https://new-api.bpjs-kesehatan.go.id/pcare-rest-v3.0` |
| **Antrean** | Online queue booking | All facilities | `https://apijkn.bpjs-kesehatan.go.id/antreanrs` |
| **Apotek** | Pharmacy claims | Pharmacy | `https://new-api.bpjs-kesehatan.go.id/apotek-rest` |
| **E-Klaim** | INA-CBG grouping | Inpatient | Via SATUSEHAT integration |
| **Aplicares** | Facility search | Public | `https://new-api.bpjs-kesehatan.go.id:8080/aplicaresws/rest` |
| **i-Care** | Care coordination | FKTP/FKRTL | `https://new-api.bpjs-kesehatan.go.id/icare-rest` |

### Development URLs
- VClaim: `https://apijkn-dev.bpjs-kesehatan.go.id/vclaim-rest-dev`
- PCare: `https://dvlp.bpjs-kesehatan.go.id:9081/pcare-rest-v3.0`
- Antrean: `https://apijkn-dev.bpjs-kesehatan.go.id/antreanrs_dev`

---

## US-12.1: Authentication & Credentials Setup

### User Story
**As a** system administrator
**I want to** configure BPJS API credentials securely
**So that** the clinic can access all BPJS services

### Acceptance Criteria

- [ ] **GIVEN** clinic has BPJS credentials
      **WHEN** configuring integration
      **THEN** system stores cons_id, secret_key, user_key encrypted

- [ ] **GIVEN** API call is made
      **WHEN** generating signature
      **THEN** system creates valid HMAC-SHA256 signature

### Authentication Headers

All BPJS API calls require these headers:

```http
X-cons-id: {consumer_id}
X-timestamp: {unix_timestamp_in_seconds}
X-signature: {base64(HMAC-SHA256(cons_id + "&" + timestamp, secret_key))}
user_key: {user_key_from_bpjs}
Content-Type: application/json
```

### Signature Generation

```javascript
// Example signature generation
const crypto = require('crypto');

function generateSignature(consId, secretKey) {
  const timestamp = Math.floor(Date.now() / 1000);
  const message = consId + "&" + timestamp;
  const signature = crypto
    .createHmac('sha256', secretKey)
    .update(message)
    .digest('base64');

  return { timestamp, signature };
}
```

### Response Decryption

BPJS responses are encrypted. Decryption requires:
1. Key: `cons_id + secret_key + timestamp`
2. Algorithm: AES-256-CBC
3. IV: From key hash

```javascript
// Decryption key generation
const key = crypto.createHash('sha256')
  .update(consId + secretKey + timestamp)
  .digest();
```

### Data Model

```yaml
bpjs_config:
  id: uuid
  organization_id: uuid (FK)

  # Credentials (all encrypted at rest)
  cons_id: string (encrypted)
  secret_key: string (encrypted)

  # User Keys (different per service)
  vclaim_user_key: string (encrypted)
  pcare_user_key: string (encrypted)
  antrean_user_key: string (encrypted)
  apotek_user_key: string (encrypted)
  icare_user_key: string (encrypted)

  # PCare specific
  pcare_username: string (encrypted)
  pcare_password: string (encrypted)
  pcare_app_code: string

  # Facility info
  ppk_code: string # PPK (Pelaksana Pelayanan Kesehatan) code
  ppk_name: string
  facility_type: enum (fktp/fkrtl)

  # Environment
  environment: enum (development/production)

  # Status
  is_active: boolean (default: true)
  last_health_check: datetime (nullable)
  health_status: enum (healthy/degraded/unhealthy)

  created_at: datetime
  updated_at: datetime

bpjs_api_log:
  id: uuid
  service: enum (vclaim/pcare/antrean/apotek/eklaim/aplicares/icare)
  endpoint: string
  method: enum (GET/POST/PUT/DELETE)

  # Request
  request_headers: jsonb
  request_body: jsonb (nullable)

  # Response
  response_code: integer
  response_body: jsonb
  response_metadata: jsonb # metaData from BPJS

  # Timing
  request_time: datetime
  response_time: datetime
  duration_ms: integer

  # Status
  success: boolean
  error_code: string (nullable)
  error_message: text (nullable)
```

### Credential Request Process

1. Submit formal letter (Surat Permohonan Bridging) to BPJS Branch Office
2. Include: facility registration proof, IT contact person
3. BPJS provides development credentials
4. Complete UAT (User Acceptance Testing) with BPJS team
5. Register public IP/Domain for whitelisting
6. Receive production credentials

---

## US-12.2: Kepesertaan (Eligibility Check)

### User Story
**As a** registration staff
**I want to** check BPJS membership eligibility
**So that** I confirm patient's coverage before service

### Acceptance Criteria

- [ ] **GIVEN** patient has BPJS number or NIK
      **WHEN** checking eligibility
      **THEN** system shows membership status, class, and primary facility

- [ ] **GIVEN** membership is not active
      **WHEN** viewing result
      **THEN** system shows specific reason (tunggakan, dll)

### VClaim API Endpoints

#### Get Peserta by BPJS Card Number
```http
GET /VClaim/rest/Peserta/nokartu/{noKartu}/tglSEP/{tglSEP}
```

#### Get Peserta by NIK
```http
GET /VClaim/rest/Peserta/nik/{nik}/tglSEP/{tglSEP}
```

### Response Structure

```json
{
  "metaData": {
    "code": "200",
    "message": "OK"
  },
  "response": {
    "peserta": {
      "noKartu": "0001234567890",
      "nik": "3275xxxxxxxxxxxx",
      "nama": "PATIENT NAME",
      "pisa": "1",
      "sex": "L",
      "tglLahir": "1990-01-15",
      "tglCetakKartu": "2014-01-01",
      "tglTAT": "2030-12-31",
      "tglTMT": "2014-01-01",
      "umur": {
        "umurSekarang": "35 tahun, 0 bulan, 10 hari",
        "umurSaatPelayanan": "35 tahun, 0 bulan, 10 hari"
      },
      "statusPeserta": {
        "kode": "0",
        "keterangan": "AKTIF"
      },
      "jenisPeserta": {
        "kode": "1",
        "keterangan": "PBI"
      },
      "hakKelas": {
        "kode": "3",
        "keterangan": "Kelas 3"
      },
      "informasi": {
        "dinpikredit": null,
        "prolpisMPsi": null
      },
      "cob": {
        "nmAsuransi": null,
        "noAsuransi": null,
        "tglTAT": null,
        "tglTMT": null
      },
      "provUmum": {
        "kdProvider": "0301R001",
        "nmProvider": "PUSKESMAS XXX"
      }
    }
  }
}
```

### Status Codes

| statusPeserta.kode | Keterangan |
|-------------------|------------|
| 0 | AKTIF |
| 1 | MENINGGAL |
| 2 | TIDAK AKTIF (TUNGGAKAN) |
| 3 | PINDAH JAMINAN |

### Data Model

```yaml
bpjs_peserta:
  id: uuid
  patient_id: uuid (FK)

  # BPJS info
  no_kartu: string # 13 digits
  nik: string # 16 digits
  nama: string

  # Membership
  status_peserta_code: string
  status_peserta_keterangan: string
  jenis_peserta_code: string
  jenis_peserta_keterangan: string # PBI, PPU, PBPU, etc.
  hak_kelas: enum (1/2/3)

  # Dates
  tgl_lahir: date
  tgl_tmt: date # Tanggal Mulai Terdaftar
  tgl_tat: date # Tanggal Akhir Terdaftar
  tgl_cetak_kartu: date

  # Primary provider
  prov_umum_code: string
  prov_umum_name: string

  # COB (Coordination of Benefits) - if has additional insurance
  cob_nama_asuransi: string (nullable)
  cob_no_asuransi: string (nullable)

  # Last check
  last_checked_at: datetime
  last_check_response: jsonb

  created_at: datetime
  updated_at: datetime

bpjs_eligibility_check:
  id: uuid
  patient_id: uuid (FK)
  no_kartu: string

  # Check
  check_type: enum (by_card/by_nik)
  check_date: date # tglSEP parameter
  check_datetime: datetime
  checked_by: uuid (FK)

  # Result
  is_eligible: boolean
  status_code: string
  status_message: string

  # If not eligible
  ineligibility_reason: enum (inactive/deceased/arrears/transferred, nullable)

  response_data: jsonb
```

---

## US-12.3: SEP (Surat Eligibilitas Peserta)

### User Story
**As a** registration staff
**I want to** create, update, and manage SEP
**So that** BPJS patients can receive covered services

### Acceptance Criteria

- [ ] **GIVEN** patient is BPJS eligible
      **WHEN** creating SEP
      **THEN** system obtains SEP number from BPJS

- [ ] **GIVEN** SEP needs correction
      **WHEN** updating within allowed period
      **THEN** system updates SEP data

- [ ] **GIVEN** visit is cancelled
      **WHEN** deleting SEP
      **THEN** system removes SEP from BPJS

### VClaim SEP Endpoints

#### Create SEP (Insert)
```http
POST /VClaim/rest/SEP/2.0/insert

Request Body:
{
  "request": {
    "t_sep": {
      "noKartu": "0001234567890",
      "tglSep": "2025-12-26",
      "ppkPelayanan": "0301R001",
      "jnsPelayanan": "2",
      "klsRawat": {
        "klsRawatHak": "3",
        "klsRawatNaik": "",
        "pembiayaan": "1",
        "penanggungJawab": ""
      },
      "noMR": "MR-20251226-0001",
      "rujukan": {
        "asalRujukan": "1",
        "tglRujukan": "2025-12-25",
        "noRujukan": "0301P001251225001",
        "ppkRujukan": "0301P001"
      },
      "catatan": "Kontrol paska rawat",
      "diagAwal": "J06.9",
      "poli": {
        "tujuan": "INT",
        "eksekutif": "0"
      },
      "cob": {
        "cob": "0"
      },
      "katarak": {
        "katarak": "0"
      },
      "jaminan": {
        "lakaLantas": "0",
        "penjamin": {
          "tglKejadian": "",
          "keterangan": "",
          "suplesi": {
            "suplesi": "0",
            "noSepSuplesi": "",
            "lokasiLaka": {
              "kdPropinsi": "",
              "kdKabupaten": "",
              "kdKecamatan": ""
            }
          }
        }
      },
      "tujuanKunj": "0",
      "flagProcedure": "",
      "kdPenunjang": "",
      "assesmentPel": "",
      "skdp": {
        "noSurat": "",
        "kodeDPJP": ""
      },
      "dpjpLayan": "123456",
      "noTelp": "08123456789",
      "user": "Admin"
    }
  }
}
```

#### Update SEP
```http
PUT /VClaim/rest/SEP/2.0/update

Request Body:
{
  "request": {
    "t_sep": {
      "noSep": "0301R001261220250001",
      "klsRawat": {
        "klsRawatHak": "3",
        "klsRawatNaik": ""
      },
      "noMR": "MR-20251226-0001",
      "catatan": "Updated notes",
      "diagAwal": "J06.9",
      "poli": {
        "tujuan": "INT",
        "eksekutif": "0"
      },
      "cob": {
        "cob": "0"
      },
      "dpjpLayan": "123456",
      "noTelp": "08123456789",
      "user": "Admin"
    }
  }
}
```

#### Delete SEP
```http
DELETE /VClaim/rest/SEP/2.0/delete

Request Body:
{
  "request": {
    "t_sep": {
      "noSep": "0301R001261220250001",
      "user": "Admin"
    }
  }
}
```

#### Get SEP Details
```http
GET /VClaim/rest/SEP/{noSep}
```

### SEP Parameters Reference

| Parameter | Values | Description |
|-----------|--------|-------------|
| `jnsPelayanan` | 1 = Rawat Inap, 2 = Rawat Jalan | Type of service |
| `klsRawatHak` | 1, 2, 3 | Patient's entitled class |
| `asalRujukan` | 1 = FKTP, 2 = FKRTL | Referral source |
| `tujuanKunj` | 0 = Normal, 1 = Prosedur, 2 = Konsul Dokter | Visit purpose |
| `lakaLantas` | 0 = Bukan, 1 = KLL, 2 = KK, 3 = KLL & KK | Traffic accident |
| `penjamin` | 1 = Jasa Raharja, 2 = BPJS TK, 3 = TASPEN, 4 = ASABRI | Guarantor |

### Data Model

```yaml
bpjs_sep:
  id: uuid
  patient_id: uuid (FK)
  encounter_id: uuid (FK, nullable)
  admission_id: uuid (FK, nullable)

  # SEP info
  no_sep: string (unique)
  tgl_sep: date
  no_kartu: string

  # Service type
  jns_pelayanan: enum (rawat_inap/rawat_jalan)
  ppk_pelayanan: string
  ppk_pelayanan_nama: string

  # Class
  kls_rawat_hak: enum (1/2/3)
  kls_rawat_naik: enum (1/2/3, nullable) # if upgrading
  pembiayaan: enum (1/2/3) # 1=peserta, 2=pemberi kerja, 3=pemerintah
  penanggung_jawab: string (nullable)

  # Medical record
  no_mr: string

  # Referral
  asal_rujukan: enum (fktp/fkrtl)
  no_rujukan: string (nullable)
  tgl_rujukan: date (nullable)
  ppk_rujukan: string (nullable)

  # Clinical
  diag_awal: string # ICD-10
  poli_tujuan: string
  poli_eksekutif: boolean (default: false)

  # DPJP
  dpjp_layan: string # Doctor code
  dpjp_nama: string

  # Visit purpose
  tujuan_kunj: enum (normal/prosedur/konsul_dokter)

  # Accident (if applicable)
  laka_lantas: enum (bukan/kll/kk/kll_kk)
  penjamin: string (nullable) # comma-separated: 1,2,3,4
  tgl_kejadian: date (nullable)

  # COB
  has_cob: boolean (default: false)

  # Catarak flag
  is_katarak: boolean (default: false)

  # Status
  status: enum (created/used/updated/deleted)

  # Audit
  created_by: uuid (FK)
  created_at: datetime
  updated_at: datetime (nullable)
  deleted_at: datetime (nullable)
  deleted_by: uuid (FK, nullable)

  # API response
  api_response: jsonb

bpjs_sep_fingerprint:
  id: uuid
  sep_id: uuid (FK)
  fingerprint_data: text # Base64 encoded
  captured_at: datetime
  captured_by: uuid (FK)
```

---

## US-12.4: Rujukan (Referral Management)

### User Story
**As a** doctor
**I want to** manage BPJS referrals
**So that** patients can be referred with valid rujukan numbers

### Acceptance Criteria

- [ ] **GIVEN** patient needs referral to specialist
      **WHEN** creating rujukan
      **THEN** system registers with BPJS

- [ ] **GIVEN** rujukan exists
      **WHEN** checking validity
      **THEN** system shows remaining visit count (max 3)

### VClaim Rujukan Endpoints

#### Get Rujukan by Number
```http
GET /VClaim/rest/Rujukan/{noRujukan}
```

#### Get Rujukan List by BPJS Card
```http
GET /VClaim/rest/Rujukan/RS/Peserta/{noKartu}
```

#### Get Rujukan from FKTP
```http
GET /VClaim/rest/Rujukan/Peserta/{noKartu}
```

#### Insert Rujukan (for FKRTL internal referral)
```http
POST /VClaim/rest/Rujukan/2.0/insert

Request Body:
{
  "request": {
    "t_rujukan": {
      "noSep": "0301R001261220250001",
      "tglRujukan": "2025-12-26",
      "tglRencanaKunjungan": "2025-12-28",
      "ppkDirujuk": "0301R002",
      "jnsPelayanan": "2",
      "catatan": "Rujuk ke spesialis jantung",
      "diagRujukan": "I10",
      "tipeRujukan": "0",
      "poliRujukan": "JAN",
      "user": "Dr. Smith"
    }
  }
}
```

#### Update Rujukan
```http
PUT /VClaim/rest/Rujukan/2.0/update
```

#### Delete Rujukan
```http
DELETE /VClaim/rest/Rujukan/2.0/delete
```

### Rujukan Business Rules

1. **Validity**: 90 days from creation
2. **Usage**: Can be used up to 3 times
3. **Same Diagnosis**: Must be for same condition
4. **Specialist**: Only valid for specified specialty

### Data Model

```yaml
bpjs_rujukan:
  id: uuid
  patient_id: uuid (FK)
  encounter_id: uuid (FK, nullable)

  # Rujukan info
  no_rujukan: string
  tgl_rujukan: date
  tgl_rencana_kunjungan: date (nullable)

  # Type
  tipe_rujukan: enum (0/1/2) # 0=penuh, 1=partial, 2=prb
  jns_pelayanan: enum (rawat_inap/rawat_jalan)

  # Source
  ppk_asal: string
  ppk_asal_nama: string

  # Destination
  ppk_dirujuk: string
  ppk_dirujuk_nama: string
  poli_rujukan: string

  # Clinical
  diag_rujukan: string # ICD-10
  catatan: text

  # Validity
  masa_berlaku: date # 90 days from creation
  jumlah_kunj: integer (default: 0) # max 3
  sisa_kunj: integer (default: 3)

  # Status
  status: enum (active/used/expired/cancelled)

  # Tracking
  created_at: datetime
  created_by: uuid (FK)

  api_response: jsonb

bpjs_rujukan_khusus:
  id: uuid
  rujukan_id: uuid (FK)

  # For special conditions
  diagnosa_khusus: enum (thalasemia/hemofilia/transplantasi_ginjal/etc)
  no_sktm: string (nullable) # Surat Keterangan Tidak Mampu

  # For PRB (Program Rujuk Balik)
  is_prb: boolean (default: false)
  obat_prb: jsonb (nullable) # list of PRB medications
```

---

## US-12.5: Antrean Online (Mobile JKN Queue)

### User Story
**As a** system integrator
**I want to** provide queue endpoints for Mobile JKN
**So that** patients can book appointments online

### Acceptance Criteria

- [ ] **GIVEN** patient books via Mobile JKN
      **WHEN** request is received
      **THEN** system creates antrian and returns queue number

- [ ] **GIVEN** patient checks in
      **WHEN** arriving at facility
      **THEN** system updates antrian status

### Antrean API - Facility as Provider

**Note**: For Antrean, the healthcare facility provides the API (as server), and BPJS calls it.

#### Required Endpoints (Facility must provide)

```yaml
endpoints:
  # Authentication
  - path: /auth
    method: POST
    description: Generate token for BPJS

  # Reference data
  - path: /ref/poli
    method: GET
    description: List of polyclinics

  - path: /ref/dokter
    method: GET
    description: List of doctors

  - path: /ref/jadwaldokter
    method: GET
    description: Doctor schedules

  # Queue operations
  - path: /antrean/add
    method: POST
    description: Create new antrian

  - path: /antrean/status
    method: GET
    description: Get antrian status

  - path: /antrean/sisa
    method: GET
    description: Get remaining queue

  - path: /antrean/batal
    method: POST
    description: Cancel antrian

  - path: /antrean/checkin
    method: POST
    description: Patient check-in

  # Operation schedule (for surgeries)
  - path: /jadwaloperasi
    method: GET
    description: Surgery schedules
```

#### Request: Add Antrian
```json
{
  "nomorkartu": "0001234567890",
  "nik": "3275xxxxxxxxxxxx",
  "nohp": "08123456789",
  "kodepoli": "INT",
  "norm": "MR-001",
  "tanggalperiksa": "2025-12-26",
  "kodedokter": "123456",
  "jampraktek": "08:00-12:00",
  "jeniskunjungan": 1,
  "nomorreferensi": "0301P001251225001"
}
```

#### Response: Add Antrian
```json
{
  "metadata": {
    "code": 200,
    "message": "OK"
  },
  "response": {
    "nomorantrean": "A-25",
    "angkaantrean": 25,
    "kodebooking": "1703561234",
    "norm": "MR-001",
    "namapoli": "Poli Penyakit Dalam",
    "namadokter": "dr. John Doe, Sp.PD",
    "estimasidilayani": 1703561234000,
    "siession": "08:00-12:00",
    "kuotajkn": 20,
    "sisaquotajkn": 15,
    "kuotanonjkn": 10,
    "sisaquotanonjkn": 8
  }
}
```

### Antrean API - Facility as Consumer

#### Get Task ID List (from BPJS)
```http
POST /Antrean/rest/TaskID/ListTaskId

Request:
{
  "kodepoli": "INT",
  "tanggal": "2025-12-26"
}
```

#### Update Waktu Antrian
```http
POST /Antrean/rest/Antrian/UpdateWaktu

Request:
{
  "kodebooking": "1703561234",
  "taskid": 3,
  "waktu": 1703561234000
}
```

### Task IDs for Antrean

| taskid | Description | Waktu |
|--------|-------------|-------|
| 1 | Mulai waktu tunggu admisi | Check-in time |
| 2 | Akhir waktu tunggu admisi / Mulai waktu layan admisi | Called to admin |
| 3 | Akhir waktu layan admisi / Mulai waktu tunggu poli | Admin done |
| 4 | Akhir waktu tunggu poli / Mulai waktu layan poli | Called to doctor |
| 5 | Akhir waktu layan poli / Mulai waktu tunggu farmasi | Doctor done |
| 6 | Akhir waktu tunggu farmasi / Mulai waktu layan farmasi | Called to pharmacy |
| 7 | Akhir waktu layan farmasi / Pasien selesai | Pharmacy done |
| 99 | Batal / Pasien tidak datang | Cancelled/No-show |

### Data Model

```yaml
bpjs_antrean:
  id: uuid
  patient_id: uuid (FK)
  encounter_id: uuid (FK, nullable)

  # Booking
  kode_booking: string (unique)
  tanggal_periksa: date
  nomor_antrean: string
  angka_antrean: integer

  # Patient
  no_kartu: string
  nik: string
  no_hp: string
  norm: string

  # Schedule
  kode_poli: string
  nama_poli: string
  kode_dokter: string
  nama_dokter: string
  jam_praktek: string

  # Referral
  jenis_kunjungan: enum (1/2/3/4) # 1=rujukan, 2=kontrol, 3=konsul, 4=tanpa rujukan
  nomor_referensi: string (nullable)

  # Estimation
  estimasi_dilayani: bigint # Unix timestamp ms

  # Quota
  kuota_jkn: integer
  sisa_kuota_jkn: integer
  kuota_non_jkn: integer
  sisa_kuota_non_jkn: integer

  # Status
  status: enum (booked/checkin/called/serving/done/cancelled)

  # Timestamps (task tracking)
  waktu_task_1: datetime (nullable) # check-in
  waktu_task_2: datetime (nullable) # admisi done
  waktu_task_3: datetime (nullable) # poli waiting
  waktu_task_4: datetime (nullable) # doctor start
  waktu_task_5: datetime (nullable) # doctor done
  waktu_task_6: datetime (nullable) # pharmacy start
  waktu_task_7: datetime (nullable) # complete

  created_at: datetime
  updated_at: datetime
```

---

## US-12.6: PCare (Primary Care)

### User Story
**As a** FKTP staff (Puskesmas)
**I want to** manage patient visits in PCare
**So that** primary care services are documented

### Acceptance Criteria

- [ ] **GIVEN** patient visits FKTP
      **WHEN** recording kunjungan
      **THEN** system submits to PCare

### PCare API Endpoints

#### Reference Data
```http
GET /pcare-rest-v3.0/poli                    # List polyclinics
GET /pcare-rest-v3.0/dokter/{start}/{limit}  # List doctors
GET /pcare-rest-v3.0/diagnosa/{keyword}/{start}/{limit}  # Search ICD-10
GET /pcare-rest-v3.0/tindakan/kdTkp/{kodeTkp}  # Procedures by location
GET /pcare-rest-v3.0/obat/{keyword}          # Search medications
GET /pcare-rest-v3.0/spesialis               # Specialist list
GET /pcare-rest-v3.0/fktp/{keyword}/{start}/{limit}  # Search FKTP
GET /pcare-rest-v3.0/kesadaran               # Consciousness levels
```

#### Peserta (Participant)
```http
GET /pcare-rest-v3.0/peserta/{noKartu}       # By BPJS card
GET /pcare-rest-v3.0/peserta/nik/{nik}       # By NIK
```

#### Kunjungan (Visits)
```http
# Add visit
POST /pcare-rest-v3.0/kunjungan

Request:
{
  "noKunjungan": null,
  "noKartu": "0001234567890",
  "tglDaftar": "26-12-2025",
  "kdPoli": "001",
  "keluhan": "Demam 3 hari",
  "kdSadar": "01",
  "sistole": 120,
  "diastole": 80,
  "beratBadan": 70,
  "tinggiBadan": 170,
  "respRate": 20,
  "heartRate": 80,
  "lingkarPerut": 80,
  "kdStatusPulang": "3",
  "tglPulang": "26-12-2025",
  "kdDokter": "12345",
  "kdDiag1": "J06.9",
  "kdDiag2": null,
  "kdDiag3": null,
  "kdPoliRujukInternal": null,
  "rujukLanjut": null,
  "kdTacc": "-1",
  "alpikredit": null
}

# Get visit
GET /pcare-rest-v3.0/kunjungan/{noKunjungan}

# Update visit
PUT /pcare-rest-v3.0/kunjungan

# Delete visit
DELETE /pcare-rest-v3.0/kunjungan/{noKunjungan}
```

#### Tindakan (Procedures)
```http
POST /pcare-rest-v3.0/tindakan

Request:
{
  "noKunjungan": "0301P001261220250001",
  "kdTindakanSK": "10001"
}
```

#### Rujukan (Referral from FKTP)
```http
POST /pcare-rest-v3.0/rujukan

Request:
{
  "noKunjungan": "0301P001261220250001",
  "kdKhusus": "00",
  "kdSubSpesialis": "1",
  "kdSarana": "0301R001",
  "catatan": "Rujuk untuk pemeriksaan lanjutan"
}
```

### PCare Status Pulang Codes

| Code | Description |
|------|-------------|
| 1 | Meninggal |
| 2 | Rujuk |
| 3 | Sembuh |
| 4 | Sakit |

### Data Model

```yaml
bpjs_pcare_kunjungan:
  id: uuid
  patient_id: uuid (FK)
  encounter_id: uuid (FK)

  # Visit
  no_kunjungan: string
  tgl_daftar: date
  kd_poli: string

  # Subjective
  keluhan: text

  # Objective
  kd_sadar: string # kesadaran code
  sistole: integer
  diastole: integer
  berat_badan: decimal
  tinggi_badan: decimal
  resp_rate: integer
  heart_rate: integer
  lingkar_perut: decimal (nullable)

  # Assessment
  kd_diag1: string # ICD-10
  kd_diag2: string (nullable)
  kd_diag3: string (nullable)

  # Plan
  kd_status_pulang: enum (1/2/3/4)
  tgl_pulang: date

  # Doctor
  kd_dokter: string

  # Referral (if applicable)
  rujuk_lanjut: jsonb (nullable)

  # TACC
  kd_tacc: string # -1 = tidak ada

  # Status
  sync_status: enum (pending/synced/failed)
  synced_at: datetime (nullable)
  sync_error: text (nullable)

  api_response: jsonb

  created_at: datetime
  updated_at: datetime
```

---

## US-12.7: INA-CBG / E-Klaim (Inpatient Claims)

### User Story
**As a** case manager
**I want to** process INA-CBG claims
**So that** inpatient services are reimbursed properly

### Acceptance Criteria

- [ ] **GIVEN** inpatient encounter is complete
      **WHEN** running grouper
      **THEN** system calculates INA-CBG tariff

- [ ] **GIVEN** claim is submitted
      **WHEN** processing with SATUSEHAT
      **THEN** Encounter ID is validated for claim amount

### INA-CBG Overview

INA-CBG (Indonesia Case Based Groups) is the prospective payment system for BPJS inpatient claims:
- **789 codes** for inpatient (Rawat Inap)
- **288 codes** for outpatient (Rawat Jalan)
- Uses ICD-10 for diagnosis, ICD-9-CM for procedures
- Tariff varies by region, hospital class, and severity level

### Severity Levels

| Level | Description | Tariff Impact |
|-------|-------------|---------------|
| I | Tanpa komplikasi/komorbid | Base tariff |
| II | Komplikasi ringan | ~120% of base |
| III | Komplikasi berat | ~150% of base |

### SATUSEHAT Integration for E-Klaim

Based on [SATUSEHAT Klaim BPJS documentation](https://satusehat.kemkes.go.id/platform/docs/id/interoperability/klaim-bpjs/):

#### Workflow Steps

1. **Coverage Data** - BPJS sends membership data
2. **Visit Registration** - Create Encounter in SATUSEHAT
3. **Account & Clinical Data** - Submit medical records
4. **Invoice Generation** - Create billing records
5. **Claim Submission** - E-Klaim initiates claim
6. **Claim Bundle** - Send FHIR resources
7. **Purification** - BPJS reviews claim
8. **Verification** - Final verification

#### Required FHIR Resources

```yaml
claim_bundle:
  financial_resources:
    - Coverage # Insurance coverage
    - Account # Patient account
    - ChargeItem # Service charges
    - Invoice # Billing invoice
    - Claim # Claim submission
    - ClaimResponse # Claim result

  clinical_resources:
    - Encounter # Visit record (REQUIRED)
    - Condition # Diagnoses
    - Procedure # Procedures performed
    - Observation # Clinical observations
    - MedicationRequest # Prescriptions
```

#### Validation Requirement

> **Important**: Claim validation uses **Encounter ID** from SATUSEHAT to calculate reimbursement amount. Facilities must integrate with SATUSEHAT before submitting claims.

### E-Klaim API Methods

```yaml
eklaim_methods:
  # Claim data
  set_claim_data:
    description: Submit claim details
    parameters:
      - nomor_sep
      - nomor_kartu
      - tgl_masuk
      - tgl_pulang
      - jenis_rawat # 1=rawat inap, 2=rawat jalan
      - kelas_rawat # 1, 2, 3
      - adl_sub_acute
      - adl_chronic
      - icu_indicator
      - icu_los # length of stay in ICU
      - ventilator_hour
      - diagnosa # array of ICD-10
      - procedure # array of ICD-9-CM
      - tarif_rs # breakdown tariff

  # Grouper
  grouping:
    description: Run INA-CBG grouper
    input: nomor_sep
    output:
      - code_cbg
      - deskripsi
      - tarif

  # Claim status
  get_claim_status:
    description: Check claim status
    input: nomor_sep
```

### Data Model

```yaml
bpjs_inacbg_claim:
  id: uuid
  admission_id: uuid (FK)
  sep_id: uuid (FK)
  patient_id: uuid (FK)

  # Admission details
  no_sep: string
  no_kartu: string
  tgl_masuk: date
  tgl_pulang: date
  jenis_rawat: enum (rawat_inap/rawat_jalan)
  kelas_rawat: enum (1/2/3)

  # Patient demographics
  umur_tahun: integer
  umur_hari: integer
  jenis_kelamin: enum (L/P)
  berat_badan: integer (nullable) # for neonates

  # ICU
  icu_indicator: boolean (default: false)
  icu_los: integer (default: 0)
  ventilator_hour: integer (default: 0)

  # ADL (Activities of Daily Living)
  adl_sub_acute: integer (nullable)
  adl_chronic: integer (nullable)

  # Diagnoses
  diagnosa_primer: string # ICD-10
  diagnosa_sekunder: array[string]

  # Procedures
  procedure_primer: string (nullable) # ICD-9-CM
  procedure_sekunder: array[string]

  # Grouper result
  inacbg_code: string (nullable)
  inacbg_description: string (nullable)
  severity_level: enum (I/II/III, nullable)

  # Tariff
  tarif_inacbg: decimal (nullable)
  tarif_rs: decimal (nullable) # hospital proposed
  tarif_penyesuaian: decimal (nullable) # adjustments
  tarif_top_up: decimal (nullable)
  tarif_final: decimal (nullable)

  # SATUSEHAT
  satusehat_encounter_id: string (nullable)
  satusehat_claim_id: string (nullable)

  # Status
  grouper_status: enum (pending/grouped/submitted/purified/verified/paid/rejected)
  grouped_at: datetime (nullable)
  submitted_at: datetime (nullable)
  purified_at: datetime (nullable)
  verified_at: datetime (nullable)

  # Purification
  purification_status: enum (pending/clean/returned, nullable)
  purification_notes: text (nullable)

  # Verification
  verification_status: enum (pending/approved/partial/rejected, nullable)
  verified_amount: decimal (nullable)
  rejection_reason: text (nullable)

  api_response: jsonb

  created_at: datetime
  updated_at: datetime
```

---

## US-12.8: Monitoring & Reporting

### User Story
**As a** BPJS coordinator
**I want to** monitor claims and generate reports
**So that** revenue is tracked and issues are resolved promptly

### Acceptance Criteria

- [ ] **GIVEN** claims are submitted
      **WHEN** viewing dashboard
      **THEN** system shows real-time claim status

### VClaim Monitoring Endpoints

```http
# Klaim by date range
GET /VClaim/rest/Monitoring/Klaim/Tanggal/{tglMasuk}/{tglPulang}

# Klaim by SEP
GET /VClaim/rest/Monitoring/Klaim/NoSEP/{noSep}

# Kunjungan (Visit) by date
GET /VClaim/rest/Monitoring/Kunjungan/Tanggal/{tglSEP}

# History Pelayanan (Service History)
GET /VClaim/rest/Monitoring/HistoriPelayanan/NoKartu/{noKartu}/tglMulai/{tglMulai}/tglAkhir/{tglAkhir}

# Jasaraharja (Accident Claims)
GET /VClaim/rest/monitoring/JasaRaharja/tglMulai/{tglMulai}/tglAkhir/{tglAkhir}
```

### Data Model

```yaml
bpjs_claim_monitoring:
  id: uuid
  period_month: integer
  period_year: integer

  # SEP Summary
  total_sep_created: integer
  sep_rawat_jalan: integer
  sep_rawat_inap: integer

  # Claims by status
  claims_pending: integer
  claims_in_verification: integer
  claims_approved: integer
  claims_rejected: integer
  claims_partial: integer

  # Amounts
  total_amount_claimed: decimal
  total_amount_approved: decimal
  total_amount_pending: decimal
  total_amount_rejected: decimal

  # By service type
  outpatient_count: integer
  outpatient_amount: decimal
  inpatient_count: integer
  inpatient_amount: decimal

  # Aging
  claims_0_7_days: integer
  claims_8_30_days: integer
  claims_over_30_days: integer

  # Performance
  avg_processing_days: decimal
  claim_success_rate: decimal

  generated_at: datetime

bpjs_rejection_analysis:
  id: uuid
  period_month: integer
  period_year: integer

  # By rejection reason
  rejections_by_reason: jsonb
  # Array of {reason_code, reason_text, count, amount}

  # Top rejections
  top_rejection_reasons: jsonb

  # Resolution
  rejections_resolved: integer
  rejections_appealed: integer
  rejections_accepted: integer

  generated_at: datetime
```

### BPJS Dashboard Widgets

```yaml
bpjs_dashboard:
  # Real-time
  today:
    sep_created: integer
    eligibility_checks: integer
    claims_submitted: integer
    pending_sync: integer

  # This month
  monthly:
    total_bpjs_patients: integer
    total_revenue_claimed: decimal
    total_revenue_approved: decimal
    approval_rate: decimal

  # Claim aging
  aging:
    - bucket: "0-7 days"
      count: integer
      amount: decimal
    - bucket: "8-30 days"
      count: integer
      amount: decimal
    - bucket: ">30 days"
      count: integer
      amount: decimal

  # Alerts
  alerts:
    - type: string
      severity: enum (info/warning/critical)
      message: string
      count: integer
```

---

## Error Codes Reference

### VClaim Error Codes

| Code | Description | Action |
|------|-------------|--------|
| 100 | Peserta tidak ditemukan | Verify BPJS number/NIK |
| 101 | Kartu tidak aktif | Inform patient |
| 102 | SEP sudah ada untuk tanggal yang sama | Check existing SEP |
| 103 | Rujukan sudah digunakan | Get new rujukan |
| 104 | Rujukan tidak ditemukan | Verify rujukan number |
| 105 | Masa berlaku rujukan habis | Get new rujukan |
| 106 | PPK tidak sesuai | Check facility code |
| 107 | Kelas rawat melebihi hak | Adjust class or upgrade |
| 108 | Peserta dirujuk bukan ke Faskes ini | Check referral destination |
| 109 | Diagnosis tidak sesuai dengan poliklinik | Verify ICD-10 and poly |
| 200 | Success | - |
| 201 | Data created | - |
| 400 | Bad request | Check request format |
| 401 | Unauthorized | Check credentials |
| 404 | Not found | Check resource exists |
| 500 | Internal server error | Retry later |

---

## Dependencies

- Patient Management (BPJS number, NIK)
- Satusehat Integration (Encounter ID for claims)
- Medical Services (diagnoses, procedures)
- Pharmacy (medication dispense)
- Billing (tariff integration)

## Blocks

- Revenue Reporting (BPJS revenue)
- Financial Reconciliation

---

## References

- [BPJS TrustMark Portal](https://dvlp.bpjs-kesehatan.go.id:8888/trust-mark/portal.html)
- [SATUSEHAT Klaim BPJS](https://satusehat.kemkes.go.id/platform/docs/id/interoperability/klaim-bpjs/)
- [VClaim Portal](https://vclaim.bpjs-kesehatan.go.id/)
- [GitHub: ssecd/jkn](https://github.com/ssecd/jkn) - NodeJS BPJS Client
- [GitHub: aamdsam/bridging-bpjs](https://github.com/aamdsam/bridging-bpjs) - Laravel BPJS
- [SIMGos V2 Documentation](https://docs.simgos2.simpel.web.id/docs/integrasi/bpjs/vclaim/)

